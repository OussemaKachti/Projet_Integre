{% extends 'baseAdmin.html.twig' %}

{% block title %}Poll Details
{% endblock %}

{% block stylesheets %}
	{{ parent() }}
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
	<link href="https://cdn.jsdelivr.net/npm/apexcharts@3.41.0/dist/apexcharts.css" rel="stylesheet">
	<style>
		.bin-button {
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
			width: 25px;
			height: 25px;
			border-radius: 5px;
			background-color: rgb(255, 95, 95);
			cursor: pointer;
			border: 3px solid rgb(255, 201, 201);
			transition-duration: 0.3s;
		}

		.bin-bottom {
			width: 15px;
		}

		.bin-top {
			width: 17px;
			transform-origin: right;
			transition-duration: 0.3s;
		}

		.bin-button:hover .bin-top {
			transform: rotate(45deg);
		}

		.bin-button:hover {
			background-color: rgb(255, 0, 0);
		}

		.bin-button:active {
			transform: scale(0.9);
		}

		.action-buttons {
			display: flex;
			gap: 10px;
			align-items: center;
		}

		.chart-container {
			position: relative;
			height: 400px;
			width: 100%;
			margin-top: 20px;
		}

		.column:hover {
			transform: translateY(-5px);
			box-shadow: 5px 8px 20px rgba(0, 0, 0, 0.3);
		}

		.chart-container {
			padding: 20px;
			margin-top: 20px;
		}

		.column-wrapper {
			display: flex;
			flex-direction: column;
			align-items: center;
		}

		/* Correction du page-body-wrapper */
		.page-body-wrapper {
			padding-left: 0 !important;
			padding-right: 0 !important;
			width: calc(100% - 260px) !important;
			max-width: none !important;
			margin-left: 260px !important;
			background: #f8f9fc !important;
		}

		/* Pour le mode responsive quand la sidebar est cachée */
		@media(max-width: 991px) {
			.page-body-wrapper {
				width: 100% !important;
				margin-left: 0 !important;
			}
		}

		/* Ajustement du container-fluid */
		.container-fluid {
			padding: 30px !important;
		}

		/* Ajustement des cartes */
		.card {
			border: none !important;
			border-radius: 15px !important;
			box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05) !important;
			transition: transform 0.3s, box-shadow 0.3s !important;
			margin-bottom: 25px !important;
			background: white !important;
		}

		.card:hover {
			transform: translateY(-5px) !important;
			box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1) !important;
		}

		.card-title {
			color: #2c3e50 !important;
			font-size: 1.25rem !important;
			font-weight: 600 !important;
			margin-bottom: 1.5rem !important;
			border-bottom: 2px solid #f1f1f1 !important;
			padding-bottom: 10px !important;
		}

		/* Style du tableau */
		.table {
			margin: 0 !important;
		}

		.table thead th {
			background: #f8f9fc !important;
			color: #2c3e50 !important;
			font-weight: 600 !important;
			border-bottom: 2px solid #e3e6f0 !important;
			padding: 15px !important;
		}

		.table tbody td {
			padding: 15px !important;
			vertical-align: middle !important;
			color: #5a5c69 !important;
			border-bottom: 1px solid #f1f1f1 !important;
		}

		/* Style des barres de progression */
		.progress {
			height: 25px !important;
			border-radius: 50px !important;
			background-color: #f1f1f1 !important;
			margin: 10px 0 !important;
			overflow: hidden !important;
		}

		.progress-bar {
			background: linear-gradient(45deg, #4e73df, #36b9cc) !important;
			border-radius: 50px !important;
			transition: width 0.6s ease !important;
		}

		/* Style des colonnes de statistiques */
		.column {
			background: linear-gradient(45deg, #4e73df, #36b9cc) !important;
			border-radius: 8px !important;
			transition: all 0.3s ease !important;
		}

		.column:hover {
			transform: translateY(-5px) !important;
			box-shadow: 0 8px 25px rgba(78, 115, 223, 0.25) !important;
		}

		/* Style des informations */
		.poll-info {
			color: #5a5c69 !important;
			line-height: 1.8 !important;
		}

		.poll-info strong {
			color: #2c3e50 !important;
			font-weight: 600 !important;
		}

		/* Style des boutons */
		.bin-button {
			background: #e74a3b !important;
			border: none !important;
			border-radius: 8px !important;
			padding: 8px 15px !important;
			color: white !important;
			transition: all 0.3s ease !important;
		}

		.bin-button:hover {
			background: #d52a1a !important;
			transform: translateY(-2px) !important;
		}

		/* Responsive design */
		@media(max-width: 991px) {
			.container-fluid {
				padding: 15px !important;
			}
		}

		/* Style pour la barre de défilement */
		.table-responsive::-webkit-scrollbar {
			width: 8px;
		}

		.table-responsive::-webkit-scrollbar-track {
			background: #f1f1f1;
			border-radius: 4px;
		}

		.table-responsive::-webkit-scrollbar-thumb {
			background: #888;
			border-radius: 4px;
		}

		.table-responsive::-webkit-scrollbar-thumb:hover {
			background: #555;
		}

		/* Style pour l'en-tête fixe */
		thead th {
			border-top: none !important;
			box-shadow: 0 2px 4px rgba(0,0,0,0.05);
		}

		/* Style pour le tableau */
		.table-responsive {
			border-radius: 8px;
			scrollbar-width: thin;
			scrollbar-color: #888 #f1f1f1;
		}

		.table td, .table th {
			white-space: nowrap;
		}

		/* Style du bouton de suppression */
		.bin-button {
			display: flex;
			align-items: center;
			justify-content: center;
			width: 35px;
			height: 35px;
			border-radius: 8px;
			background-color: #ff5f5f;
			border: none;
			cursor: pointer;
			transition: all 0.3s ease;
		}

		.bin-button:hover {
			background-color: #ff3333;
			transform: translateY(-2px);
		}

		.bin-button:active {
			transform: scale(0.95);
		}

		.bin-button i {
			color: white;
			font-size: 1rem;
		}

		/* Animation de suppression */
		tr {
			transition: all 0.3s ease;
		}

		tr.removing {
			opacity: 0;
			transform: translateX(-20px);
		}

		.navigation {
			margin-top: 20px;
			display: flex;
			justify-content: center;
		}

		.page-link {
			color: #4e73df !important;
			border: 1px solid #e3e6f0 !important;
			margin: 0 3px !important;
			border-radius: 5px !important;
			cursor: pointer;
		}

		.page-item.active .page-link {
			background-color: #4e73df !important;
			border-color: #4e73df !important;
			color: white !important;
		}

		.page-link:hover {
			background-color: #eaecf4 !important;
			border-color: #e3e6f0 !important;
		}

		.page-item.disabled .page-link {
			color: #858796 !important;
			background-color: #fff !important;
			border-color: #e3e6f0 !important;
		}
	</style>
{% endblock %}

{% block body %}
	<div
		class="container-fluid">
		<!-- Première ligne : Poll Information et Comments côte à côte -->
		<div
			class="row mb-4">
			<!-- Poll Information -->
			<div class="col-lg-6">
				<div class="card h-100">
					<br>
					<br>
					<br>
					<div class="card-body">
						<h4 class="card-title">Poll Information</h4>
						<div class="poll-info">
							<p>
								<strong>Question:</strong>
								{{ sondage.question }}</p>
							<p>
								<strong>Club:</strong>
								{{ sondage.club.nomC }}</p>
							<p>
								<strong>Created At:</strong>
								{{ sondage.createdAt|date('d/m/Y H:i') }}</p>
						</div>
					</div>
				</div>
			</div>

			<!-- Comments -->
			<div class="col-lg-6">
				<div class="card h-100">
					<div class="card-body">
						<h4 class="card-title">Comments</h4>
						<div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
							<table class="table">
								<thead style="position: sticky; top: 0; background: white; z-index: 1;">
									<tr>
										<th style="width: 20%">User</th>
										<th style="width: 40%">Comment</th>
										<th style="width: 25%">Created At</th>
										<th style="width: 15%">Actions</th>
									</tr>
								</thead>
								<tbody>
									{% for comment in comments %}
										<tr>
											<td>{{ comment.user.fullName }}</td>
											<td>{{ comment.contenuComment }}</td>
											<td>{{ comment.dateComment|date('d/m/Y H:i') }}</td>
											<td class="text-center">
												<button class="bin-button" data-id="{{ comment.id }}">
													<i class="fas fa-trash"></i>
												</button>
											</td>
										</tr>
									{% endfor %}
								</tbody>
							</table>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- Deuxième ligne : Statistiques -->
		<div
			class="row">
			<!-- Response Statistics -->
			<div class="col-lg-6">
				<div class="card">
					<div class="card-body">
						<h4 class="card-title">Response Statistics</h4>

						{% for result in poll_results %}
							<div class="mb-3">
								<div class="d-flex justify-content-between mb-1">
									<span>{{ result.choix }}</span>
									<span>{{ result.count }}
										votes ({{ result.percentage }}%)</span>
								</div>
								<div class="progress" style="height: 25px;">
									<div class="progress-bar" role="progressbar" style="width: {{ result.percentage }}%; background-color: #ffd700;" aria-valuenow="{{ result.percentage }}" aria-valuemin="0" aria-valuemax="100">
										{{ result.percentage }}%
									</div>
								</div>
							</div>
						{% endfor %}
					</div>
				</div>
			</div>

			<!-- Votes Distribution -->
			<div class="col-lg-6">
				<div class="card">
					<div class="card-body">
						<h4 class="card-title mb-2">Votes Distribution</h4>
						<div class="chart-container" style="position: relative; height: 150px; width: 100%; margin-top: 0px;">
							<div class="d-flex justify-content-around align-items-end" style="height: 100%;">
								{% for result in poll_results %}
									{% if result.count > 0 %}
										<div class="column-wrapper" style="text-align: center; width: {{ 80 / poll_results|length }}%;">
											<div class="column" style="height: {{ result.percentage }}%;
																																																					background: linear-gradient(45deg, #ffd700, #ffed4a);
																																																					border-radius: 8px 8px 0 0;
																																																					box-shadow: 5px 5px 15px rgba(0,0,0,0.2);
																																																					position: relative;
																																																					transition: all 0.3s ease;
																																																					min-height: 20px;
																																																					margin: 0 10px;">
												<div style="position: absolute;
																																																									top: -20px;
																																																									left: 50%;
																																																									transform: translateX(-50%);
																																																									white-space: nowrap;
																																																									font-size: 0.9rem;
																																																									font-weight: bold;">
													{{ result.count }} votes
												</div>
											</div>
											<div style="margin-top: 5px; font-weight: bold; font-size: 0.9rem;">
												{{ result.choix }}
											</div>
											<div style="color: #666; font-size: 0.8rem;">
												{{ result.percentage }}%
											</div>
										</div>
									{% endif %}
								{% endfor %}
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>



{% endblock %}

{% block javascripts %}
	{{ parent() }}
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<script>
		$(document).ready(function () {
if ($("#lineChart").length) {
var ctx = $("#lineChart").get(0).getContext("2d");
var pollData = {{ poll_results|json_encode|raw }};

var gradientFill = ctx.createLinearGradient(0, 0, 0, 200);
gradientFill.addColorStop(0, 'rgba(75, 73, 172, 0.5)');
gradientFill.addColorStop(1, 'rgba(75, 73, 172, 0.1)');

new Chart(ctx, {
type: 'line',
data: {
labels: pollData.map(item => item.choix),
datasets: [
{
label: 'Distribution des votes',
data: pollData.map(item => item.count),
borderColor: '#4747A1',
backgroundColor: gradientFill,
fill: true,
tension: 0.4,
pointBackgroundColor: '#4747A1',
pointBorderColor: '#fff',
pointBorderWidth: 2,
pointRadius: 6,
pointHoverRadius: 8,
pointHoverBackgroundColor: '#fff',
pointHoverBorderColor: '#4747A1',
pointHoverBorderWidth: 2
}
]
},
options: {
responsive: true,
maintainAspectRatio: false,
scales: {
y: {
beginAtZero: true,
grid: {
color: 'rgba(0, 0, 0, 0.05)'
},
ticks: {
stepSize: 1,
font: {
size: 12
}
}
},
x: {
grid: {
display: false
},
ticks: {
font: {
size: 12
}
}
}
},
plugins: {
legend: {
display: false
},
tooltip: {
backgroundColor: 'rgba(0, 0, 0, 0.8)',
titleFont: {
size: 13
},
bodyFont: {
size: 13
},
padding: 15,
callbacks: {
label: function (context) {
const item = pollData[context.dataIndex];
return `Votes: ${
item.count
} (${
item.percentage
}%)`;
}
}
}
},
interaction: {
intersect: false,
mode: 'index'
}
}
});
}

document.addEventListener('DOMContentLoaded', function() {
	// Gestion de la suppression des commentaires
	const deleteButtons = document.querySelectorAll('.bin-button');
	
	deleteButtons.forEach(button => {
		button.addEventListener('click', function() {
			const commentId = this.getAttribute('data-id');
			
			if (confirm('Are you sure you want to delete this comment?')) {
				fetch(`/admin/comments/delete/${commentId}`, {
					method: 'DELETE',
					headers: {
						'X-Requested-With': 'XMLHttpRequest'
					}
				})
				.then(response => response.json())
				.then(data => {
					if (data.success) {
						// Suppression de la ligne du tableau
						this.closest('tr').remove();
						// Message de succès
						alert('Comment deleted successfully!');
					} else {
						alert('Error deleting comment');
					}
				})
				.catch(error => {
					console.error('Error:', error);
					alert('An error occurred while deleting the comment');
				});
			}
		});
	});

	// Gestion du clic sur les liens de pagination
	document.querySelector('.navigation').addEventListener('click', function(e) {
		if (e.target.classList.contains('page-link')) {
			e.preventDefault();
			const page = e.target.getAttribute('data-page') || 1;
			
			// Récupération des données avec AJAX
			fetch(`/adminPolls?page=${page}&q=${encodeURIComponent(document.querySelector('#search').value)}`)
				.then(response => response.json())
				.then(data => {
					// Mise à jour du tableau
					updateTable(data.sondages);
					// Mise à jour de la pagination
					updatePagination(data.currentPage, data.pageCount);
				});
		}
	});
});

function updateTable(sondages) {
	// Fonction pour mettre à jour le contenu du tableau
	const tbody = document.querySelector('table tbody');
	tbody.innerHTML = '';
	
	sondages.forEach(sondage => {
		tbody.innerHTML += `
			<tr>
				<td>${sondage.question}</td>
				<td>${sondage.club_name}</td>
				<td>${sondage.created_at}</td>
				<td>
					<!-- Vos actions -->
				</td>
			</tr>
		`;
	});
}

function updatePagination(currentPage, pageCount) {
	// Mise à jour de l'état actif des boutons de pagination
	document.querySelectorAll('.page-item').forEach(item => {
		const pageNum = parseInt(item.querySelector('.page-link').getAttribute('data-page'));
		if (pageNum === currentPage) {
			item.classList.add('active');
		} else {
			item.classList.remove('active');
		}
	});
}
	</script>
{% endblock %}
