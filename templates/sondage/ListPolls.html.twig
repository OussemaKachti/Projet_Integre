{% extends 'base.html.twig' %}

{% block title %}{% endblock %}

{% block body %}
   <main>

    <!-- Breadcrumb Area Start -->
    <section class="breadcrumb__area include-bg pt-150 pb-150 breadcrumb__overlay" data-background="{{ asset('front_assets/img/breadcrumb/poll.jpg') }}">
        <div class="container">
            <div class="row">
                <div class="col-xxl-12">
                    <div class="breadcrumb__content text-center p-relative z-index-1">
                        <h3 class="breadcrumb__title">Our Polls</h3>
                        <div class="breadcrumb__list">
                            <span><a href="index.html">Home</a></span>
                            <span class="dvdr"><i class="fa-regular fa-angle-right"></i></span>
                            <span>Polls</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!-- Breadcrumb Area End -->

    <!-- Blog Area Start -->
    <section class="blog__area pt-120 pb-120">
    <div class="container">
        <div class="row">
            <!-- Polls Section -->
            <div class="col-xxl-8 col-xl-8 col-lg-8">
                <div class="postbox__wrapper postbox__details pr-20">
                    <div class="postbox__item transition-3 mb-70">
                        <div class="postbox__content">
                            {% for sondage in sondages %}
                            <div class="poll-container" data-sondage-id="{{ sondage.id }}">
                                <div class="user-info">
                                    <img src="{{ asset('front_assets/img/blog/comments/user.png') }}" alt="User">
                                    <b>{{ sondage.user.nom }} {{ sondage.user.prenom }}</b> |
                                    <span>{{ sondage.createdAt|date('d M Y') }}</span>
                                    <span class="menu-icon" onclick="toggleMenu(event)">&#8230;</span>
                                    <div class="menu-list">
                                        <ul>
                                            <li onclick="editPoll()">Edit Poll</li>
                                            <li onclick="deletePoll({{ sondage.id }})">Delete Poll</li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="poll-title">{{ sondage.question }}</div>
                                {% for choix in sondage.choix %}
                                <input type="radio" name="poll" id="none" checked hidden>
                                <div class="poll-option option-{{ loop.index }}">
                                    <input type="radio" name="poll" id="option-{{ loop.index }}">
                                    <label>{{ choix.contenu }}</label>
                                    <div class="progress-bar">
                                        <div class="progress"></div>
                                    </div>
                                </div>
                                {% endfor %}

                                <!-- Comments Section -->
                              <div class="latest-comment mb-3">
                                  <!-- Rendre le h3 cliquable avec un style pointer -->
                                  <h3 class="openModal" style="cursor: pointer;" data-sondage-id="{{ sondage.id }}">
                                       {{ sondage.commentaires|length }} Comments
                                  </h3>
                                  <style>
                                    .openModal {
                                       font-size: 14px !important;  /* Taille de police plus petite avec priorité */
                                       font-weight: normal !important;  /* Enlever le gras avec priorité */
                                       color: #555 !important;  /* Couleur plus douce avec priorité */
                                       margin: 0 !important;  /* Enlever la marge si nécessaire avec priorité */
                                               }                                  
                                  </style>
                                  <!-- Modal -->
                                 <div class="modal fade" id="commentsModal{{ sondage.id }}" tabindex="-1" aria-labelledby="commentsModalLabel{{ sondage.id }}" aria-hidden="true">
                                    <div class="modal-dialog modal-lg" role="document">
                                      <div class="modal-content">
                                        <div class="modal-header">
                                          <h5 class="modal-title" id="commentsModalLabel{{ sondage.id }}">All Comments</h5>
                                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body">
                                          <div class="comments-list">
                                            {% for commentaire in sondage.commentaires %}
                                             <div class="comment-box" id="comment-{{ commentaire.id }}">
                                                <div class="comment-info d-flex">
                                                      <div class="comment-avatar mr-20">
                                                         <img src="{{ asset('assets/img/blog/comments/user.png') }}" alt="">
                                                      </div>
                                                      <div class="avatar-name">
                                                         <h5>{{ commentaire.user.nom }} {{ commentaire.user.prenom }}</h5>
                                                         <span class="post-meta">{{ commentaire.dateComment|date('d M Y') }}</span>
                                                      </div>
                                                </div>
                                                <div class="comment-text">
                                                      <p>{{ commentaire.contenuComment }}</p>
                                                </div>

                                                
                                                      <div class="comment-actions">
                                                         <!-- Edit Button -->
                                                       <form action="{{ path('edit_comment', {'id': commentaire.id}) }}" method="POST">
                                                            <input type="hidden" name="_method" value="PUT"> <!-- Cela simule une requête PUT -->
                                                            <textarea name="content" placeholder="Edit your comment">{{ commentaire.contenuComment }}</textarea>
                                                            <button type="submit">Update Comment</button>
                                                       </form>


                                                         
                                                         <!-- Delete Button -->
                                                         <form action="{{ path('delete_comment', {'id': commentaire.id}) }}" method="POST" onsubmit="return confirm('Are you sure you want to delete this comment?');">
                                                               <input type="hidden" name="_method" value="DELETE">
                                                               <button type="submit" class="btn btn-danger">Delete</button>
                                                         </form>                                                  

                                                      </div>
                                                         <p>Aucun utilisateur connecté</p>
                                             </div>
                                          {% else %}
                                             <p>No comments yet.</p>
                                             {% endfor %}                                          

                                          </div>
                                        </div>
                                        <div class="modal-footer">
                                          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                        </div>
                                      </div>
                                    </div>
                                  </div>
                                </div>


                                <!-- Comment Form -->
                                <div class="postbox__comment">
                                    <h3>Write a comment</h3>
                                    <form id="comment-form-{{ sondage.id }}" data-sondage-id="{{ sondage.id }}">
                                        <div class="row">
                                            <div class="col-xxl-12">
                                                <div class="postbox__comment-input">
                                                    <textarea placeholder="Enter your comment ..." class="comment-textarea"></textarea>
                                                </div>
                                            </div>
                                            <div class="col-xxl-12">
                                                <div class="postbox__comment-btn">
                                                    <button type="submit" class="tp-btn">Post Comment</button>
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                    <br>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar Section -->
            <div class="col-xxl-4 col-xl-4 col-lg-4">
                <div class="blog__sidebar pl-70">
                    <form id="poll-form" method="POST" action="{{ path('api_poll_new') }}">
                        <div class="poll-creation-container">
                            <h2>Create a Poll</h2>
                            <input type="text" class="input-box" placeholder="Type your question here" name="question">
                            <h2>Options</h2>
                            <div id="options-container">
                                <input type="text" class="input-box" placeholder="Option 1" name="choix[0][contenu]">
                                <input type="text" class="input-box" placeholder="Option 2" name="choix[1][contenu]">
                            </div>
                            <button type="button" class="add-option" onclick="addOption()">+ Add option</button>
                            <div class="admin-message">
                                <p><strong>Note:</strong> Ensure the question and options follow club rules.</p>
                            </div>
                            <button type="submit" class="create-btn">Create Poll</button>
                        </div>
                    </form>
                    <button class="button" onclick="window.location.href='allPolls.html';">View all polls</button>
                </div>
            </div>
        </div>
    </div>
</section>

<script>

       
   document.addEventListener("DOMContentLoaded", function() {
    // Cibler tous les h3 avec la classe .openModal
    const openModalButtons = document.querySelectorAll('.openModal');

    openModalButtons.forEach(button => {
        button.addEventListener('click', function(event) {
            const sondageId = this.getAttribute("data-sondage-id");

            // Vérifier si l'ID du sondage existe
            if (sondageId) {
                // Trouver le modal correspondant à cet ID
                const modal = new bootstrap.Modal(document.getElementById('commentsModal' + sondageId));
                modal.show();
            }
        });
    });
});


               document.addEventListener("DOMContentLoaded", function () {
            // Select all poll containers
            const pollContainers = document.querySelectorAll('.poll-container');

            pollContainers.forEach(pollContainer => {
               const sondageId = pollContainer.getAttribute('data-sondage-id');
               
               // Fetch comments for the specific poll
               fetch(`/comment/list/${sondageId}`)
                     .then(response => response.json())
                     .then(data => {
                        const commentList = document.getElementById(`comment-list-${sondageId}`);
                        commentList.innerHTML = ''; // Clear any existing comments

                        // If there are comments, append them to the list
                        if (data.length > 0) {
                           data.forEach(comment => {
                                 const li = document.createElement('li');
                                 li.innerHTML = `
                                    <div class="comments-box grey-bg-2">
                                       <div class="comments-info d-flex">
                                             <div class="comments-avatar mr-20">
                                                <img src="assets/img/blog/comments/user.png" alt="">
                                             </div>
                                             <div class="avatar-name">
                                                <h5>${comment.user}</h5>
                                                <span class="post-meta">${comment.date}</span>
                                             </div>
                                             <div class="comments-replay">
                                                <a href="#">delete</a>
                                             </div>
                                       </div>
                                       <div class="comments-text ml-65">
                                             <p>${comment.content}</p>
                                       </div>
                                    </div>
                                 `;
                                 commentList.appendChild(li);
                           });
                        } else {
                           // If no comments, display a message
                           commentList.innerHTML = '<li>No comments yet.</li>';
                        }
                     })
                     .catch(error => console.error('Error fetching comments:', error));
            });
               });
               function addComment(event) {
                  // Get the poll ID from the 'data-sondage-id' attribute
                  let sondageId = event.target.getAttribute('data-sondage-id');
                  
                  // Get the comment text
                  let commentText = event.target.querySelector('.comment-textarea').value;

                  // Check if the comment field is empty
                  if (!commentText.trim()) {
                     alert("The comment cannot be empty.");
                     return;
                  }

                  // Send the comment to the backend via fetch
                  fetch(`/commentaire/comment/add/${sondageId}`, {
                     method: 'POST',
                     headers: {
                           'Content-Type': 'application/json'
                     },
                     body: JSON.stringify({
                           contenuComment: commentText
                     })
                  })
                  .then(response => response.json())
                  .then(data => {
                     if (data.error) {
                           alert(data.error);
                     } else {
                           alert(data.message);  // Show success message
                           // Manually clear the comment text field after successful submission
                           event.target.querySelector('.comment-textarea').value = '';
                           // Optionally: Add the comment to the list of comments displayed on the page
                           loadComments(sondageId);  // Reload the comments for the specific poll
                     }
                  })
                  .catch(error => {
                     console.error('Error adding comment:', error);
                  });
               }

</script>
<!-- jQuery et Bootstrap JS -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Blog Area End -->
</main>

{% endblock %}
